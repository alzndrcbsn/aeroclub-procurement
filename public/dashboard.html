<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aero.AMT Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      height: 100%;
      background: #333;
      color: #333;
      transition: background-color 0.5s, color 0.5s;
    }
    .bg-blur-wrapper {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      z-index: 0;
      pointer-events: none;
    }
    .bg-blur-img {
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      filter: blur(16px);
      position: absolute;
      top: 0; left: 0;
    }
    body.dark .bg-blur-img {
      filter: blur(16px) brightness(0.5);
    }
    .dashboard-content {
      position: relative;
      z-index: 1;
    }

    .bg-blur-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      z-index: 0;
      backdrop-filter: blur(16px);
      pointer-events: none;
    }
    body.dark .bg-blur-overlay {
      background: rgba(30,30,30,0.5);
    }

    body.dark .section-box,
    body.dark header,
    body.dark .dropdown-content,
    body.dark .modal,
    body.dark .sidebar {
      background-color: rgba(30, 30, 30, 0.85);
      color: #eee;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1.5rem;
      background-color: #004578;
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      z-index: 1000;
    }

    .project-title {
      font-size: 1.5rem;
      font-weight: 700;
      display: block;
    }

    .header-center {
      flex: 1;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .profile-area {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .profile-area img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
    }

    .profile-area button {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      top: 45px;
      background-color: #fff;
      min-width: 150px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      z-index: 1001;
      border-radius: 6px;
      overflow: hidden;
      animation: fadeIn 0.2s;
    }

    .dropdown-content a {
      color: #000;
      padding: 10px;
      display: block;
      text-decoration: none;
    }

    .dropdown-content a:hover {
      background-color: #f1f1f1;
    }

    .sidebar {
      width: 200px;
      background-color: #004578;
      color: white;
      height: calc(100vh - 64px);
      position: fixed;
      top: 64px;
      left: 0;
      padding: 1rem 0.5rem 1rem 1rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      z-index: 999;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      border-top-right-radius: 12px;
    }

    .sidebar.show {
      transform: translateX(0);
    }

    .sidebar h2 {
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    .sidebar a {
      color: white;
      text-decoration: none;
      margin: 6px 0;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.3s;
      padding: 8px 10px;
      border-radius: 6px;
    }

    .sidebar a:hover {
      transform: translateX(5px);
      text-decoration: underline;
      background: rgba(255,255,255,0.08);
    }

    .content {
      margin-left: 0;
      padding: 6rem 2rem 2rem;
      transition: margin-left 0.3s ease;
    }

    .sidebar.show ~ .content {
      margin-left: 200px;
    }

    @media (max-width: 700px) {
      .sidebar.show ~ .content {
        margin-left: 0;
      }
    }

    .greeting {
      font-size: 2rem;
      margin: 1rem 0;
      color: #fff;
      font-weight: 700;
      text-shadow: 1px 1px 3px #00000077;
    }

    .section-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: center;
    }

    .section-box {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      padding: 1.5rem 1.2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.18s cubic-bezier(.4,2,.3,1), background-color 0.18s cubic-bezier(.4,2,.3,1), box-shadow 0.18s cubic-bezier(.4,2,.3,1);
      cursor: pointer;
      font-size: 1.08rem;
      min-width: 0;
      width: 320px;
      height: 320px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      word-break: break-word;
      overflow: hidden;
    }

    .section-box:hover {
      transform: scale(1.04) translateY(-6px);
      background-color: #e3f0fa;
      box-shadow: 0 8px 32px rgba(0,120,212,0.18);
      z-index: 2;
    }

    .section-box h3 {
      font-size: 1.25rem;
      margin-bottom: 0.7rem;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .section-box canvas {
      width: 100% !important;
      height: 180px !important;
      max-width: 260px;
      margin: 0 auto 0.6rem auto;
      display: block;
    }

    .section-box #request-updates {
      width: 100%;
      max-height: 90px;
      overflow-y: auto;
      font-size: 1rem;
      margin-top: 0.4rem;
    }

    .section-box #request-updates h4 {
      font-size: 1.08rem;
      margin: 0 0 6px 0;
      text-align: left;
    }

    .section-box #updates-list {
      padding-left: 16px;
      margin: 0;
    }

    .section-box #updates-list li {
      margin-bottom: 6px;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.35);
      justify-content: center;
      align-items: center;
      transition: opacity 0.2s;
    }
    .modal-content {
      background: #fff;
      border-radius: 10px;
      padding: 1.2rem 1.5rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      max-width: 350px;
      width: 90vw;
      position: relative;
      font-size: 1rem;
      color: #222;
    }
    .modal-close {
      position: absolute;
      top: 10px; right: 16px;
      font-size: 1.3rem;
      background: none;
      border: none;
      color: #333;
      cursor: pointer;
    }

    #notification {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #0078D4;
      color: white;
      padding: 14px 28px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 9999;
      font-size: 1.08rem;
      pointer-events: none;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .search-container {
      position: relative;
      width: 250px;
      margin: 0 auto;
    }

    #search-bar {
      width: 100%;
      padding: 7px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    .search-suggestions {
      position: absolute;
      top: 110%;
      left: 0;
      width: 100%;
      background: #fff;
      border-radius: 0 0 6px 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      z-index: 1002;
      display: none;
      max-height: 180px;
      overflow-y: auto;
    }

    .search-suggestions .suggestion {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .search-suggestions .suggestion:last-child {
      border-bottom: none;
    }

    .search-suggestions .suggestion:hover {
      background: #f1f1f1;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <script>
    // Simple authentication check: redirect to index.html if not logged in
    if (!localStorage.getItem('isLoggedIn')) {
      window.location.replace('index.html');
    }
  </script>
  <div class="bg-blur-wrapper">
    <img class="bg-blur-img" src="https://images.unsplash.com/photo-1535914254981-b5012eebbd15?auto=format&fit=crop&w=1650&q=80" alt="Background" />
  </div>
  <div class="dashboard-content">
    <header>
      <span class="project-title">Aero.AMT Dashboard</span>
      <div class="header-center" id="header-center">
        <span id="datetime-display"></span>
        <div class="search-container">
          <input type="text" id="search-bar" placeholder="Search..." autocomplete="off" />
          <div class="search-suggestions" id="search-suggestions"></div>
        </div>
      </div>
      <div class="profile-area">
        <img src="../images/logo.jpg" alt="Profile" id="profile-img" />
        <button id="theme-toggle" title="Toggle dark mode">üåô</button>
        <div class="dropdown-content" id="profile-dropdown">
          <a href="#">Profile</a>
          <a href="#">Settings</a>
          <a href="#">Logout</a>
        </div>
      </div>
    </header>

    <div class="sidebar" id="sidebar">
      <h2>Navigation <button id="closeSidebar" style="float:right;background:none;border:none;color:white;font-size:1.2rem;cursor:pointer;">&times;</button></h2>
      <a onclick="navigateTo('view-request.html')">üìã Approve Orders</a>
      <a onclick="navigateTo('schedule.html')">üìÖ Schedule</a>
      <a onclick="navigateTo('dashboard-analytics.html')">üìä Analytics</a>
      <a onclick="navigateTo('settings.html')">‚öôÔ∏è Settings</a>
    </div>

    <main class="content" id="main-content">
      <div class="greeting" id="user-greeting">Welcome!</div>
      <section id="announcements-section" style="margin-bottom:2rem;">
        <h2 style="font-size:1.3rem;color:#004578;margin-bottom:0.7rem;">üì¢ Announcements</h2>
        <div id="announcements-list" style="background:#f8f9fb;border-radius:8px;padding:1rem 1.2rem;box-shadow:0 2px 8px rgba(0,120,212,0.08);color:#222;min-height:48px;">
          <span style="color:#888;">No announcements yet.</span>
        </div>
        <form id="announcement-form" style="margin-top:1.2rem;display:flex;gap:0.7rem;align-items:center;">
          <input type="text" id="announcement-input" placeholder="Type announcement..." style="flex:1;padding:8px 12px;border-radius:6px;border:1px solid #c8c8c8;font-size:1rem;" />
          <button type="submit" style="padding:8px 18px;background:#0078D4;color:#fff;border:none;border-radius:6px;font-weight:600;cursor:pointer;">Post</button>
        </form>
    // Announcement posting logic (admin only)
    document.getElementById('announcement-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const input = document.getElementById('announcement-input');
      const text = input.value.trim();
      if (!text) return;
      // You can add admin check here if needed
      const author = localStorage.getItem('userName') || 'Admin';
      try {
        await firebase.firestore().collection('announcements').add({
          text,
          author,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        input.value = '';
        fetchAnnouncements();
      } catch (err) {
        alert('Failed to post announcement.');
      }
    });
      </section>
      <div class="section-grid">
        <div class="section-box" id="box-status">
          <h3>Requests Status Overview</h3>
          <canvas id="requestStatusChart" style="width:100%;max-width:220px;"></canvas>
          <div id="request-updates">
            <h4>Recent Updates</h4>
            <ul id="updates-list">
              <!-- Updates will be injected here -->
            </ul>
          </div>
        </div>
        <div class="section-box" id="box-monthly">
          <h3>Monthly Analytics</h3>
          <canvas id="monthlyAnalyticsChart" style="width:100%;max-width:220px;"></canvas>
        </div>
        <div class="section-box" id="box-breakdown">
          <h3>Requests Breakdown</h3>
          <canvas id="requestBreakdownChart" style="width:100%;max-width:220px;"></canvas>
        </div>
      </div>
    </main>
    <!-- Modals for each section box -->
    <div class="modal" id="modal-status">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal('modal-status')">&times;</button>
        <h3>Requests Status Overview</h3>
        <canvas id="modalRequestStatusChart" style="width:100%;max-width:220px;"></canvas>
        <div id="modal-request-updates">
          <h4>Recent Updates</h4>
          <ul id="modal-updates-list"></ul>
        </div>
      </div>
    </div>
    <div class="modal" id="modal-monthly">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal('modal-monthly')">&times;</button>
        <h3>Monthly Analytics</h3>
        <canvas id="modalMonthlyAnalyticsChart" style="width:100%;max-width:220px;"></canvas>
      </div>
    </div>
    <div class="modal" id="modal-breakdown">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal('modal-breakdown')">&times;</button>
        <h3>Requests Breakdown</h3>
        <canvas id="modalRequestBreakdownChart" style="width:100%;max-width:220px;"></canvas>
      </div>
    </div>
  </div>

  <div id="loading-screen" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:99999;justify-content:center;align-items:center;">
    <div style="background:#fff;padding:2rem 2.5rem;border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,0.18);font-size:1.3rem;color:#004578;display:flex;align-items:center;gap:1rem;">
      <span class="loader" style="width:32px;height:32px;border:4px solid #0078D4;border-top:4px solid #fff;border-radius:50%;display:inline-block;animation:spin 1s linear infinite;"></span>
      Logging out...
    </div>
  </div>

  <script>
    // Set greeting to user's name if available
    const userGreeting = document.getElementById('user-greeting');
    const userName = localStorage.getItem('userName');
    if (userName && userGreeting) {
      userGreeting.textContent = `Welcome, ${userName}!`;
    }
    // Sidebar improved behavior
    const sidebar = document.getElementById("sidebar");
    const closeSidebarBtn = document.getElementById("closeSidebar");
    let sidebarPinned = false;

    document.addEventListener("mousemove", (e) => {
      if (!sidebarPinned && e.clientX < 40) {
        sidebar.classList.add("show");
      } else if (!sidebarPinned && !sidebar.matches(":hover")) {
        sidebar.classList.remove("show");
      }
    });

    sidebar.addEventListener("mouseenter", () => {
      sidebar.classList.add("show");
    });
    sidebar.addEventListener("mouseleave", () => {
      if (!sidebarPinned) sidebar.classList.remove("show");
    });

    closeSidebarBtn.addEventListener("click", () => {
      sidebar.classList.remove("show");
      sidebarPinned = false;
    });

    sidebar.addEventListener("dblclick", () => {
      sidebarPinned = !sidebarPinned;
      if (sidebarPinned) {
        sidebar.classList.add("show");
      }
    });

    // Navigation function
    function navigateTo(page) {
      window.location.href = page;
    }

    // Profile dropdown
    const profileImg = document.getElementById("profile-img");
    const profileDropdown = document.getElementById("profile-dropdown");
    profileImg.addEventListener("click", (e) => {
      e.stopPropagation();
      profileDropdown.style.display = profileDropdown.style.display === "block" ? "none" : "block";
    });
    document.addEventListener("click", (e) => {
      if (!profileDropdown.contains(e.target) && e.target !== profileImg) {
        profileDropdown.style.display = "none";
      }
    });

    // Dark mode toggle
    const themeToggle = document.getElementById("theme-toggle");
    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      themeToggle.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
    });

    // Date/time display in header
    function updateDateTime() {
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const dateStr = now.toLocaleDateString(undefined, options);
      const timeStr = now.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      document.getElementById('datetime-display').textContent = `${dateStr} | ${timeStr}`;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Search bar functionality
    const searchBar = document.getElementById('search-bar');
    const searchSuggestions = document.getElementById('search-suggestions');
    // Example suggestions, you can replace with dynamic data
    const suggestions = [
      'Approve Orders',
      'Schedule',
      'Analytics',
      'Settings',
      'Inventory',
      'Manage Users',
      'Reports',
      'Announcements',
      'User Status'
    ];
    searchBar.addEventListener('input', function() {
      const val = this.value.toLowerCase();
      if (val.length === 0) {
        searchSuggestions.style.display = 'none';
        searchSuggestions.innerHTML = '';
        return;
      }
      const filtered = suggestions.filter(s => s.toLowerCase().includes(val));
      if (filtered.length === 0) {
        searchSuggestions.style.display = 'none';
        searchSuggestions.innerHTML = '';
        return;
      }
      searchSuggestions.innerHTML = filtered.map(s => `<div class='suggestion'>${s}</div>`).join('');
      searchSuggestions.style.display = 'block';
    });
    searchSuggestions.addEventListener('mousedown', function(e) {
      if (e.target.classList.contains('suggestion')) {
        searchBar.value = e.target.textContent;
        searchSuggestions.style.display = 'none';
        // Optionally, trigger navigation based on selection
        switch (e.target.textContent) {
          case 'Approve Orders': navigateTo('view-request.html'); break;
          case 'Schedule': navigateTo('schedule.html'); break;
          case 'Analytics': navigateTo('dashboard-analytics.html'); break;
          case 'Settings': navigateTo('settings.html'); break;
          // Add more cases as needed
        }
      }
    });
    document.addEventListener('click', function(e) {
      if (e.target !== searchBar) {
        searchSuggestions.style.display = 'none';
      }
    });

    // Example data for charts and updates
    const requestStatusData = {
      labels: ['Approved', 'Rejected', 'Revision'],
      datasets: [{
        label: 'Requests',
        data: [12, 3, 5],
        backgroundColor: ['#4caf50', '#f44336', '#ff9800'],
      }]
    };
    const monthlyAnalyticsData = {
      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
      datasets: [{
        label: 'Requests per Month',
        data: [5, 8, 6, 10, 7, 12, 9],
        backgroundColor: '#0078D4',
        borderColor: '#004578',
        borderWidth: 2,
      }]
    };
    const requestBreakdownData = {
      labels: ['Parts', 'Supplies', 'Equipment', 'Other'],
      datasets: [{
        label: 'Type',
        data: [7, 5, 3, 2],
        backgroundColor: ['#2196f3', '#8bc34a', '#ffc107', '#e91e63'],
      }]
    };
    const updates = [
      { status: 'Approved', text: 'Order #1023 approved by Admin.' },
      { status: 'Rejected', text: 'Order #1022 rejected due to incomplete info.' },
      { status: 'Revision', text: 'Order #1021 sent for revision.' },
      { status: 'Approved', text: 'Order #1020 approved by Admin.' },
    ];

    // Render charts
    window.addEventListener('DOMContentLoaded', () => {
      if (window.Chart) {
        new Chart(document.getElementById('requestStatusChart').getContext('2d'), {
          type: 'doughnut',
          data: requestStatusData,
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
        new Chart(document.getElementById('monthlyAnalyticsChart').getContext('2d'), {
          type: 'bar',
          data: monthlyAnalyticsData,
          options: { responsive: true, plugins: { legend: { display: false } } }
        });
        new Chart(document.getElementById('requestBreakdownChart').getContext('2d'), {
          type: 'pie',
          data: requestBreakdownData,
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
      }
      // Render updates
      const updatesList = document.getElementById('updates-list');
      if (updatesList) {
        updatesList.innerHTML = updates.map(u => `<li><span style='color:${u.status === 'Approved' ? '#4caf50' : u.status === 'Rejected' ? '#f44336' : '#ff9800'};font-weight:bold;'>${u.status}:</span> ${u.text}</li>`).join('');
      }
    });

    // Modal logic
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    document.getElementById('box-status').onclick = function() {
      openModal('modal-status');
      // Render modal chart and updates
      if (window.Chart) {
        new Chart(document.getElementById('modalRequestStatusChart').getContext('2d'), {
          type: 'doughnut',
          data: requestStatusData,
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
      }
      document.getElementById('modal-updates-list').innerHTML = updates.map(u => `<li><span style='color:${u.status === 'Approved' ? '#4caf50' : u.status === 'Rejected' ? '#f44336' : '#ff9800'};font-weight:bold;'>${u.status}:</span> ${u.text}</li>`).join('');
    };
    document.getElementById('box-monthly').onclick = function() {
      openModal('modal-monthly');
      if (window.Chart) {
        new Chart(document.getElementById('modalMonthlyAnalyticsChart').getContext('2d'), {
          type: 'bar',
          data: monthlyAnalyticsData,
          options: { responsive: true, plugins: { legend: { display: false } } }
        });
      }
    };
    document.getElementById('box-breakdown').onclick = function() {
      openModal('modal-breakdown');
      if (window.Chart) {
        new Chart(document.getElementById('modalRequestBreakdownChart').getContext('2d'), {
          type: 'pie',
          data: requestBreakdownData,
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
      }
    };

    // Real-time notification logic
    function showNotification(message) {
      const notif = document.getElementById('notification');
      notif.textContent = message;
      notif.style.opacity = '1';
      setTimeout(() => {
        notif.style.opacity = '0';
      }, 3500);
    }
    // Example: Simulate notifications every 15s
    setInterval(() => {
      const messages = [
        'May bagong request na pumasok!',
        'Na-approve ang isang order!',
        'May order na kailangan ng revision.',
        'May bagong user na nag-register.',
        'May rejected request.',
      ];
      const msg = messages[Math.floor(Math.random()*messages.length)];
      showNotification(msg);
    }, 15000);

    // Fix logout button functionality (use correct selector and href)
    const logoutBtn = Array.from(document.querySelectorAll('#profile-dropdown a')).find(a => a.textContent.trim().toLowerCase() === 'logout');
    if (logoutBtn) {
      logoutBtn.setAttribute('href', 'index.html');
      logoutBtn.addEventListener('click', function(e) {
        e.preventDefault();
        localStorage.removeItem('isLoggedIn');
        window.location.replace('index.html');
      });
    }
  </script>
</body>
</html>
